/*! Thrive Leads - The ultimate Lead Capture solution for wordpress - 2015-11-02
* https://thrivethemes.com 
* Copyright (c) 2015 * Thrive Themes */
var ThriveLeads=ThriveLeads||{};ThriveLeads.views=ThriveLeads.views||{},jQuery(function(){ThriveLeads.views.Assets=Backbone.View.extend({events:{"click .tve-add-asset-group":"openAddGroup","mouseenter .tve-asset-group-not-connected":"showTooltip","mouseleave .tve_tooltip_message":"hideTooltip","click .tve-available-shortcodes":"showShortcodes","click .tve-asset-group-test":"testConnection","click .tve-asset-group-save-connection":"saveConnection"},viewItems:[],initialize:function(){this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.renderOne),this.listenTo(this.collection,"remove",this.removeOne)},render:function(){return this.collection.length?this.$el.find(".show-no-asset-groups").hide():this.$el.find(".show-no-asset-groups").show(),this.collection.each(this.renderOne,this),this},removeOne:function(){0===this.collection.length&&this.$el.find(".show-no-asset-groups").show()},renderOne:function(a){this.collection.length?this.$el.find(".show-no-asset-groups").hide():this.$el.find(".show-no-asset-groups").show();var b=new ThriveLeads.views.Asset({model:a}),c=b.render().$el;this.$el.find("#tve-asset-group-list").append(c);var d=a.get("ID");tinyMCE.init({selector:"#my-id-"+d,toolbar:"styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | ",menubar:!1,height:400,setup:function(b){b.on("init",function(b){tinyMCE.get("my-id-"+d).setContent(a.get("post_content")),tinyMCE.execCommand("mceRepaint")})}}),this.viewItems.push(b)},showShortcodes:function(){ThriveLeads.open_thickbox(ThriveLeads["const"].translations.showShortcodesList,{view:"showShortcodes",height:220})},showTooltip:function(){var a=jQuery(this.$el).find(".tve-asset-group-status-icon");a.wrap('<div class="tve_tooltip_wrapper">');var b=a.attr("data-title");a.before('<div class="tooltip_arrow_border">'),a.before('<div class="tooltip_arrow">'),a.before('<div class="tve_tooltip_message">'+b,"</div>")},saveConnection:function(){var a=this.$el.find("#tve-api-connections-select option:selected").val();ThriveLeads.showLoader(),jQuery.ajax({type:"post",url:ajaxurl,data:{action:"thrive_leads_backend_ajax",route:"assets",custom:"update_service",new_connection:a}}).done(function(){ThriveLeads.hideLoader()})},testConnection:function(){var a=this.$el.find("#tve-api-connections-select option:selected").val(),b=this.$el.find(".tve-connection-response-wrapper");ThriveLeads.showLoader(),jQuery.ajax({type:"post",url:ajaxurl,data:{action:"thrive_leads_backend_ajax",route:"assets",custom:"test_service",test_connection:a}}).success(function(a){b.empty(),b.append(a),ThriveLeads.hideLoader()})},hideTooltip:function(){var a=jQuery(this.$el).find(".tve_tooltip_wrapper");a.find(".tve_tooltip_message").remove(),a.find(".tooltip_arrow").remove(),a.find(".tooltip_arrow_border").remove(),a.contents().unwrap()},updateOrder:function(){var a={};_.each(this.viewItems,function(b){b.model.get("order")!=b.$el.index()&&(b.model.set("order",b.$el.index()),a[b.model.get("ID")]=b.$el.index())}),this.collection.sort(),jQuery.ajax({type:"post",url:ajaxurl,data:{action:"thrive_leads_backend_ajax",route:"assets",custom:"update_order",new_order:a}})},openAddGroup:function(){ThriveLeads.open_thickbox(ThriveLeads["const"].translations.addAssetGroup+" "+ThriveLeads["const"].translations.AddNewAssetGroupVideo,{view:"addAssetGroup",height:220})}}),ThriveLeads.views.Asset=Backbone.View.extend({tagName:"li",className:"collapse-table-list-item",template:_.template(ThriveLeads["const"].templates["assets/item"]),events:{"click .tve-edit-title":"showEditTitleInput","change .tve-edit-title-input":"saveTitle","keyup .tve-edit-title-input":"saveTitleKeyup","blur .tve-edit-title-input":"closeEditTitle","click .tve-asset-group-delete":"deleteGroupPopup","click .tve-asset-group-details":function(a){this.model.set("details_expanded",!this.model.get("details_expanded"))},"click .tve-asset-group-heading":function(a){var b=jQuery(a.target);b.hasClass("tve-prevent-click")||b.parents(".tve-prevent-click").length||this.model.set("details_expanded",!this.model.get("details_expanded"))},"click .tve-asset-group-file-add":"addFile","click .tve-asset-group-save":"addContent"},initialize:function(){this.listenTo(this.model,"change:details_expanded",this.groupDetails),this.listenTo(this.model,"change:post_title",this.render),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model.get("files"),"add",this.renderFile),this.listenTo(this.model.get("files"),"add",this.updateCount),this.listenTo(this.model.get("files"),"remove",this.updateCount)},render:function(){console.log(this.model),this.$el.html(this.template(this.model.toJSON()));var a=this.model.get("files").length;return this.$el.find(".tve-files-count").prepend(a),this.groupDetails(),this.model.get("files").each(this.renderFile,this),this},updateCount:function(){var a=this.model.get("files").length;this.$el.find(".tve-files-count").empty(),this.$el.find(".tve-files-count").prepend(a+" Files")},addContent:function(){ThriveLeads.showLoader();var a="#my-id-"+this.model.get("ID")+"_ifr",b=this.$el.find(a),c=b.contents().find("body").html(),d=this.$el.find(".tve-subject-input").val();this.model.set("post_content",c),this.model.set("post_subject",d),this.model.save({},{success:function(a,b){},complete:function(){ThriveLeads.hideLoader()}})},addFile:function(){var a,b=this.$el.find("#asset-file-add").val();switch(b){case"media_library":var c=this.model.get("ID");if(self=this,a)return a.open(),!1;a=wp.media.frames.file_frame=wp.media({title:"Upload Asset Group Files (.zip, .pdf, .jpg, .png)",button:{text:"Use file"},multiple:!1}),a.on("select",function(){var b=a.state().get("selection").first().toJSON(),d=new ThriveLeads.models.AssetFile({name:b.name,link_anchor:b.name,link:b.url,parent_ID:c,ID:""});d.save({},{success:function(a,b){a.set("ID",b)},complete:function(){self.model.get("files").add(d)}})}),a.open();break;case"manual":ThriveLeads.open_thickbox(ThriveLeads["const"].translations.addNewFile,{view:"addNewFile",model:this.model,height:220});break;case"previous":ThriveLeads.open_thickbox(ThriveLeads["const"].translations.addNewFile,{view:"addPrevFile",collection:ThriveLeads.objects.AssetsCollection,model:this.model,height:220})}},renderFile:function(a){a.set("parent_ID",this.model.get("ID"));var b=new ThriveLeads.views.AssetFile({model:a});this.$el.find("#tve-asset-group-files").append(b.render().$el)},groupDetails:function(){this.model.get("details_expanded")?(console.log("aaa"),this.$el.addClass("tve-expanded"),this.$el.find(".tve-asset-group-details").slideDown("fast"),this.$el.find(".tve-group-details > span").attr("class","tve-icon-minus-circle")):(this.$el.removeClass("tve-expanded"),this.$el.find(".tve-asset-group-details").slideUp("fast"),this.$el.find(".tve-group-details > span").attr("class","tve-icon-plus-circle"))},deleteGroupPopup:function(a){var b=jQuery(a.currentTarget);ThriveLeads.open_thickbox(b.attr("data-title"),{width:550,height:300,view:"ConfirmDeleteAssetGroup",model:ThriveLeads.objects.AssetsCollection.get(b.attr("data-id"))})},showEditTitleInput:function(a){var b=this.$el.find(".asset-group-title").hide();this.$el.find(".tve-edit-title-input").val(b.text()).show().focus().select(),jQuery(a.currentTarget).hide(),a.stopPropagation()},saveTitle:function(a){var b=a.currentTarget.value;b!=this.model.get("post_title")&&(this.model.set("post_title",b),this.model.save()),this.closeEditTitle()},saveTitleKeyup:function(a){(27==a.which||13==a.which)&&this.closeEditTitle()},closeEditTitle:function(){var a=this.model.get("post_title");this.$el.find(".tve-edit-title-input").val(a),this.$el.find(".tve-edit-title-input").hide(),this.$el.find(".asset-group-title,.tve-edit-title").show()}}),ThriveLeads.views.AssetFile=Backbone.View.extend({tagName:"li",className:"asset-file-list-item",template:_.template(ThriveLeads["const"].templates["assets/file"]),events:{"click .tve-edit-file-name":"showEditTitleInput","change .tve-edit-file-name-input":"saveTitle","keyup .tve-edit-file-name-input":"saveTitleKeyup","blur .tve-edit-file-name-input":"closeEditTitle","click .tve-asset-file-delete":"deleteAssetFile"},initialize:function(){this.listenTo(this.model,"destroy",this.remove)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},deleteAssetFile:function(a){var b=jQuery(a.currentTarget);ThriveLeads.open_thickbox(b.attr("data-title"),{width:550,height:300,view:"ConfirmDeleteAssetFile",model:this.model})},showEditTitleInput:function(a){var b=jQuery(a.currentTarget);if(b.hasClass("tve-edit-file-name-title")){var c=this.$el.find(".asset-group-file-title").hide();this.$el.find(".tve-edit-file-name-title-input").val(c.text()).show().focus().select(),jQuery(a.currentTarget).hide(),a.stopPropagation()}else{var c=this.$el.find(".asset-group-anchor-title").hide();this.$el.find(".tve-edit-file-name-anchor-input").val(c.text()).show().focus().select(),jQuery(a.currentTarget).hide(),a.stopPropagation()}},saveTitle:function(a){var b=jQuery(a.currentTarget);if(b.hasClass("tve-edit-file-name-title-input")){var c=a.currentTarget.value;c!=this.model.get("name")&&(this.model.set("name",c),this.model.save())}else{var c=a.currentTarget.value;c!=this.model.get("link_anchor")&&(this.model.set("link_anchor",c),this.model.save())}this.closeEditTitle()},saveTitleKeyup:function(a){(27==a.which||13==a.which)&&this.closeEditTitle()},closeEditTitle:function(a){this.render()}})});