/*! Thrive Leads - The ultimate Lead Capture solution for wordpress - 2015-10-08
* https://thrivethemes.com 
* Copyright (c) 2015 * Thrive Themes */
var ThriveLeads=ThriveLeads||{};ThriveLeads.views=ThriveLeads.views||{},jQuery(function(){ThriveLeads.views.Reporting=Backbone.View.extend({el:jQuery("#tve-reporting"),$chart:jQuery("#tve-report-chart"),table_data:{},events:{"change #report_type":"changeChart","click .tve-submit-report-type":"changeChart","change .tve-chart-source-select":"changeChart","change .tve-chart-interval-select":"changeChart"},validateDate:function(a,b){"start"===a&&this.start_date!==b&&(this.start_date=b,this.$el.find("#tve-report-end-date").datepicker("option","minDate",b),this.changeChart()),"end"===a&&this.end_date!==b&&(this.end_date=b,this.$el.find("#tve-report-start-date").datepicker("option","maxDate",b),this.changeChart())},initialize:function(){var a=this,b=new Date,c=new Date(b.getTime()-6048e5);this.hide_source_views=["ConversionRate","ListGrowth","CumulativeListGrowth"],this.$form=this.$el.find("form"),this.$el.find("#tve-report-start-date").datepicker({dateFormat:"yy-mm-dd",defaultDate:"-1w",onSelect:function(b){a.validateDate("start",b)}}).on("blur",function(b){a.validateDate("start",b.target.value)}),jQuery(document).on("click",".start-date-calendar",function(){jQuery("#tve-report-start-date").datepicker("show")}),this.$el.find("#tve-report-end-date").datepicker({dateFormat:"yy-mm-dd",minDate:c,defaultDate:"+1w",onSelect:function(b){a.validateDate("end",b)}}).on("blur",function(b){a.validateDate("end",b.target.value)}),jQuery(document).on("click",".end-date-calendar",function(){jQuery("#tve-report-end-date").datepicker("show")}),jQuery("#ui-datepicker-div").hide(),this.end_date=b.getFullYear()+"-"+("0"+(b.getMonth()+1)).slice(-2)+"-"+("0"+b.getDate()).slice(-2),this.start_date=c.getFullYear()+"-"+("0"+(c.getMonth()+1)).slice(-2)+"-"+("0"+c.getDate()).slice(-2),this.$el.find("#tve-report-end-date").datepicker("setDate",this.end_date),this.$el.find("#tve-report-start-date").datepicker("setDate",this.start_date),this.pagination=new ThriveLeads.views.Pagination({total:1,collection:{}}),this.changeChart()},changeChart:function(){var a=this;"undefined"!=typeof this.chart&&this.chart.showLoading(),jQuery.ajax({url:ajaxurl+"?action=thrive_leads_backend_ajax&route=report",data:this.getData(),dataType:"json",success:function(b){("undefined"==typeof a.chartType||a.chartType&&a.chartType!==a.getChartType())&&a.drawChart(b.chart_data,b.chart_title),b.table_data&&(a.table_data=b.table_data),a.updateChart(b.chart_data,b.chart_title,b.chart_x_axis,b.chart_y_axis),a.getViewForType()}})},drawChart:function(a,b){return this.chartType=this.getChartType(),"undefined"!=typeof a&&0===a.length&&"none"!==this.chartType?this.$el.find(".tve-chart-overlay").show():this.$el.find(".tve-chart-overlay").hide(),"none"===this.chartType?void this.$el.find("#tve-report-chart").hide():void("line"===this.chartType||"area"===this.chartType?(-1!==this.hide_source_views.indexOf(this.getReportType())?this.$el.find(".tve-chart-source").hide():this.$el.find(".tve-chart-source").show(),this.$el.find("#tve-report-chart").show(),this.$el.find(".tve-chart-interval").show(),this.chart=new ThriveLeads.LineChart({title:b,data:a,renderTo:"tve-report-chart",type:this.chartType})):"pie"===this.chartType&&(this.$el.find(".tve-chart-source").hide(),this.$el.find(".tve-chart-interval").hide(),this.$el.find("#tve-report-chart").show(),this.chart=new ThriveLeads.PieChart({title:b,data:a,renderTo:"tve-report-chart"})))},updateChart:function(a,b,c,d){return"undefined"==typeof this.chart&&this.drawChart(a),"undefined"!=typeof a&&0===a.length&&"none"!==this.chartType?this.$el.find(".tve-chart-overlay").show():this.$el.find(".tve-chart-overlay").hide(),"none"===this.chartType?(jQuery(".tve-chart-source").show(),jQuery(".tve-chart-interval").hide(),void jQuery("#tve-report-chart").html("")):(-1!==this.hide_source_views.indexOf(this.getReportType())?this.$el.find(".tve-chart-source").hide():this.$el.find(".tve-chart-source").show(),this.chart.set("data",a),this.chart.set("title",b),this.chart.set("x_axis",c),this.chart.set("y_axis",d),void this.chart.redraw())},getChartType:function(){switch(this.getReportType()){case"Conversion":case"ConversionRate":case"CumulativeConversion":return"line";case"ListGrowth":case"CumulativeListGrowth":return"area";case"ComparisonChart":return"pie";case"LeadReferral":case"LeadTracking":case"LeadSource":return"none"}},getViewForType:function(){switch(ThriveLeads.objects.titleChanger.replaceFirst(this.getPageTitle()),this.getReportType()){case"Conversion":case"CumulativeConversion":case"ListGrowth":case"CumulativeListGrowth":return new ThriveLeads.views.ConversionReportList({collection:ThriveLeads.objects.ConversionReport,pagination:this.pagination,report_count_data:this.table_data.count_table_data});case"ConversionRate":return new ThriveLeads.views.ConversionRateReportList({collection:ThriveLeads.objects.ConversionRateReport,pagination:this.pagination,report_count_data:this.table_data.count_table_data,report_average_rate:this.table_data.average_rate});case"ComparisonChart":return new ThriveLeads.views.ComparisonReportList({collection:ThriveLeads.objects.ComparisonReport,pagination:this.pagination,table_data:this.table_data});case"LeadReferral":return new ThriveLeads.views.LeadReferralReportList({collection:ThriveLeads.objects.LeadReferralReport,pagination:this.pagination,report_count_data:this.table_data.count_table_data});case"LeadTracking":return new ThriveLeads.views.LeadTrackingReportList({collection:ThriveLeads.objects.LeadTrackingReport,pagination:this.pagination,report_count_data:this.table_data.count_table_data});case"LeadSource":return new ThriveLeads.views.LeadSourceReportList({collection:ThriveLeads.objects.LeadSourceReport,pagination:this.pagination,report_count_data:this.table_data.count_table_data})}},getData:function(){return this.$form.serialize()},getReportType:function(){return this.$el.find("#report_type").val()},getPageTitle:function(){return this.$el.find("#report_type option:selected").text()},render:function(){}}),ThriveLeads.views.Pagination=Backbone.View.extend({el:jQuery(".tl-pagination"),template:_.template(ThriveLeads["const"].templates["pagination/view"]),events:{"click a.page":"changePage"},currentPage:1,pageCount:1,pagesToDisplay:2,itemsPerPage:50,total_items:0,order_by:"",order_dir:"",collection:null,initialize:function(a){this.pageCount=Math.ceil(a.total/this.itemsPerPage),this.collection=a.collection},changePage:function(a,b){ThriveLeads.showLoader();var c="undefined"==typeof b?jQuery(a.currentTarget).attr("value"):parseInt(b),d=this.getFormData(),e=this;return d+="&"+jQuery.param({type:"table",page:c,itemsPerPage:this.itemsPerPage,order_by:this.order_by,order_dir:this.order_dir}),jQuery.ajax({url:ajaxurl+"?action=thrive_leads_backend_ajax&route=report",data:d,dataType:"json",success:function(a){e.currentPage=c,e.collection.reset(a),e.render(),ThriveLeads.hideLoader()}}),!1},getFormData:function(){return jQuery("#tve-reporting form").serialize()},empty:function(){this.$el.empty()},render:function(){return this.$el.html(this.template({currentPage:parseInt(this.currentPage),pageCount:parseInt(this.pageCount),pagesToDisplay:parseInt(this.pagesToDisplay),total_items:parseInt(this.total_items),itemsPerPage:this.itemsPerPage})),this}}),ThriveLeads.views.ReportingTableBase=Backbone.View.extend({el:jQuery("#tve-report-meta"),report_count_data:0,pagination:{},itemView:"",extra_fields:{},initialize:function(a){this.listenTo(this.collection,"reset",this.render),this.pagination=a.pagination,this.pagination.pageCount=Math.ceil(a.report_count_data/this.pagination.itemsPerPage),this.pagination.total_items=a.report_count_data,this.pagination.collection=this.collection,this.pagination.changePage(null,1),this.$el.html(this.template(this.extra_fields))},changeOrder:function(a){var b=jQuery(a.currentTarget).attr("data-order-by");if(b==this.pagination.order_by)switch(this.pagination.order_dir){case"DESC":this.pagination.order_dir="ASC";break;case"ASC":this.pagination.order_dir="",this.pagination.order_by="";break;case"":this.pagination.order_dir="DESC"}else this.pagination.order_by=b,this.pagination.order_dir="DESC";this.pagination.changePage(null,1)},addOne:function(a){var b=new ThriveLeads.views[this.itemView]({model:a});this.$el.find("#tve-table-items").append(b.render().el)},displayItems:function(){this.collection.each(this.addOne,this)},emptyList:function(){this.$el.find("#tve-table-items").empty()},render:function(){return this.$el.html(this.template(this.extra_fields)),this.$el.find(".tve-table-sortable").on("click",jQuery.proxy(this.changeOrder,this)),this.displayItems(),this}}),ThriveLeads.views.ConversionReportItem=ThriveLeads.views.Base.extend({tagName:"tr",template:_.template(ThriveLeads["const"].templates["reporting/conversion-report/item"])}),ThriveLeads.views.ConversionReportList=ThriveLeads.views.ReportingTableBase.extend({template:_.template(ThriveLeads["const"].templates["reporting/conversion-report/list"]),itemView:"ConversionReportItem"}),ThriveLeads.views.ConversionRateReportItem=ThriveLeads.views.Base.extend({tagName:"tr",template:_.template(ThriveLeads["const"].templates["reporting/conversion-rate-report/item"])}),ThriveLeads.views.ConversionRateReportList=ThriveLeads.views.ReportingTableBase.extend({template:_.template(ThriveLeads["const"].templates["reporting/conversion-rate-report/list"]),itemView:"ConversionRateReportItem",extra_fields:{},initialize:function(a){this.extra_fields={average_rate:a.report_average_rate},ThriveLeads.views.ReportingTableBase.prototype.initialize.call(this,a)}}),ThriveLeads.views.ComparisonReportItem=ThriveLeads.views.Base.extend({tagName:"tr",template:_.template(ThriveLeads["const"].templates["reporting/comparison-report/item"])}),ThriveLeads.views.ComparisonReportList=ThriveLeads.views.ReportingTableBase.extend({template:_.template(ThriveLeads["const"].templates["reporting/comparison-report/list"]),itemView:"ComparisonReportItem",initialize:function(a){this.collection.reset(a.table_data),a.pagination.empty(),this.render()}}),ThriveLeads.views.LeadReferralReportItem=ThriveLeads.views.Base.extend({tagName:"tr",template:_.template(ThriveLeads["const"].templates["reporting/lead-referral-report/item"])}),ThriveLeads.views.LeadReferralReportList=ThriveLeads.views.ReportingTableBase.extend({template:_.template(ThriveLeads["const"].templates["reporting/lead-referral-report/list"]),itemView:"LeadReferralReportItem"}),ThriveLeads.views.LeadTrackingReportItem=ThriveLeads.views.Base.extend({tagName:"tr",template:_.template(ThriveLeads["const"].templates["reporting/lead-tracking-report/item"])}),ThriveLeads.views.LeadTrackingReportList=ThriveLeads.views.ReportingTableBase.extend({template:_.template(ThriveLeads["const"].templates["reporting/lead-tracking-report/list"]),itemView:"LeadTrackingReportItem"}),ThriveLeads.views.LeadSourceReportItem=ThriveLeads.views.Base.extend({tagName:"tr",template:_.template(ThriveLeads["const"].templates["reporting/lead-source-report/item"])}),ThriveLeads.views.LeadSourceReportList=ThriveLeads.views.ReportingTableBase.extend({template:_.template(ThriveLeads["const"].templates["reporting/lead-source-report/list"]),itemView:"LeadSourceReportItem"})});