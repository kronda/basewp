/*! Thrive Content Builder - 2015-09-24
* http://www.thrivethemes.com/
* Copyright (c) 2015 Thrive Themes */
var TVE_Content_Builder=TVE_Content_Builder||{};!function(a){function b(b,c){var d=a.extend({post_id:tve_path_params.post_id,action:"tve_api_editor_actions"},tve_path_params.custom_post_data,b),e=a.extend({url:tve_path_params.ajax_url,data:d,type:"post"},c);return a.ajax(e)}var c,d,e=Math.floor(238*Math.random());TVE_Content_Builder.auto_responder={init:function(){return c=a(".edit_mode").tve_lead_generation(),d=a("#tve_lightbox_frame"),this},dashboard:function(a){TVE_Editor_Page.overlay();var e=c.getConnectionType(),f=a&&a.attr("data-edit-custom")?"1":0;delete c.edit_api,b({route:"dashboard",connection_type:e,edit_custom_html:f,connections:c.getApiConnections(),connections_str:c.api_config_str,thank_you_url:c.api_form_data.thank_you_url,submit_option:c.api_form_data.submit_option,api_fields:c.api_form_data.elements||null,api_fields_order:c.api_form_data.element_order||null}).done(function(a){load_lightbox_content(a.lb_html);var b=c.customFormCode();show_lightbox(),"custom-html"==e&&b&&f?(d.find('textarea[name="tve_lead_generation_code"]').val(b),jQuery(".tve_lead_generate_fields").trigger("click")):"api"==e&&a.elements&&c.setApiData(a),d.find(".tve_lightbox_buttons").hide(),TVE_Editor_Page.overlay(!0)})},generate_fields:function(){TVE_Editor_Page.overlay();var a=d.find('textarea[name="tve_lead_generation_code"]'),e={autoresponder_code:a.val(),custom:tve_path_params.custom_post_data,route:"generateFields"};b(e,{dataType:"json"}).done(function(b){jQuery("#generated_inputs_container").html(b.html),a.val(b.stripped_code),c.setParsedResponse(b),TVE_Editor_Page.overlay("close")})},save_custom_code:function(a){c.generateForm().applyStyle(),TVE_Content_Builder.controls.lb_close()},save_api_connection:function(){c.api_form_data.elements._back_url={type:"hidden",name:"_back_url",value:c.api_form_data.thank_you_url||""},c.api_form_data.elements._submit_option={type:"hidden",name:"_submit_option",value:c.api_form_data.submit_option||""},a.each(c.api_form_data.extra,function(b,d){c.api_config[b]&&a.each(d,function(a,d){c.api_form_data.elements[b+"_"+a]={type:"hidden",className:"tve-api-extra",name:b+"_"+a,value:d}})}),c.generateForm().applyStyle(),TVE_Content_Builder.controls.lb_close()},open_icon_picker:function(b){var c=b.parent(),d=a("#tve_lg_icon_list").show();if(d.find(".icomoon-icon").removeClass("tve_selected"),c.find(".icomoon-icon").length){var e=c.find(".icomoon-icon").data("cls");d.find('[data-cls="'+e+'"]').addClass("tve_selected")}this.icon_container=c},choose_icon:function(b){if(a("#tve_lg_icon_list").hide(),this.icon_container){var d=this.icon_container.find(".tve_lg_icon_picker").attr("data-field");this.icon_container.find(".icomoon-icon").remove();var e=b.clone().removeClass("tve_selected tve_click").removeAttr("data-ctrl");e.find(".tve-ic-checkmark").remove(),this.icon_container.append(e),"api"==c.getConnectionType()&&c.api_form_data.elements&&c.api_form_data.elements[d]&&(c.api_form_data.elements[d].icon=e.attr("data-cls"))}},remove_custom_html:function(){c.customFormCode(""),c.connection_type="",this.dashboard()},connection_form:function(d){TVE_Editor_Page.overlay();var e=d.attr("data-step2")?a("#connection-type").val():d.attr("data-connection-type");c.edit_api=d.attr("data-key")?d.attr("data-key"):"",b({route:"form",connections:c.getApiConnections(),api_fields:c.api_form_data.elements||null,connection_type:e,edit:c.edit_api,extra:c.api_form_data&&c.api_form_data.extra?c.api_form_data.extra:{}}).done(function(a){load_lightbox_content(a.lb_html),c.connection_type=e,show_lightbox(),TVE_Editor_Page.overlay(!0)})},api:{readExtraSettings:function(b){var d=c&&c.api_form_data&&c.api_form_data.extra?c.api_form_data.extra:{};return b.find(".tve-api-extra").filter(":not(.tve_disabled)").each(function(){var b=a(this),c=b.attr("name").split("_"),e=c.shift(),f=c.join("_");d[e]=d[e]||{},d[e][f]=b.val()}),d},_ajax:function(d){return TVE_Editor_Page.overlay(),d=a.extend({action:"tve_api_editor_actions",connections:c.getApiConnections(),api_fields:c.api_form_data.elements||null,ajax_load:""},d),b(d).done(function(){TVE_Editor_Page.overlay("close")})},reload_apis:function(){a("#thrive-api-list").remove(),this._ajax({route:"apiSelect",force_fetch:"1",edit:c.edit_api,extra:c.api_form_data&&c.api_form_data.extra?c.api_form_data.extra:{}}).done(function(b){a("#thrive-api-connections").replaceWith(b)})},api_get_lists:function(b,d){this._ajax({route:"apiLists",api:b.jquery?b.val():b,force_fetch:"undefined"!=typeof d&&d===!0?"1":0,extra:c.api_form_data&&c.api_form_data.extra?c.api_form_data.extra:{}}).done(function(b){a("#thrive-api-list").replaceWith(b)})},reload_lists:function(a){this.api_get_lists(a.attr("data-api"),!0)},save:function(b){var e=a("#thrive-api-connections-select"),f=a("#thrive-api-list-select");return e.val()&&f.val()?(b.attr("data-edit")&&b.attr("data-edit")!=e.val()&&c.removeApiConnection(b.attr("data-edit")),c.setApiConnection(e.val(),f.val()),TVE_Content_Builder.auto_responder.dashboard(),void(c.api_form_data.extra=this.readExtraSettings(d))):(alert(tve_path_params.translations.ChooseExistingAPI),!0)},remove:function(a){c.removeApiConnection(a.attr("data-key")),TVE_Content_Builder.auto_responder.dashboard()},thank_you_url:function(a){var b=a.val();b.match(/^http(s)?/)||b.match(/^\/\//)||(b="http://"+b,a.val(b)),c.api_form_data.thank_you_url=b},submit_option_changed:function(a){var b=a.val(),d=a.parent().next("input").hide();"redirect"==b&&d.show(),c.api_form_data.submit_option=b}}},jQuery.fn.extend({tve_lead_generation:function(){var b=this,c={code_separator:"__CONFIG_lead_generation_code__",$formContainer:b.find(".thrv_lead_generation_container"),jsonFields:null,form_code:"",api_config:{},connection_type:"",api_form_data:{},init:function(){return"1"!==b.data("tve-version")&&this.upgradeHtml(),this.readCustomFormCode(),this.connection_type=b.attr("data-connection"),this.connection_type||(this.connection_type=this.customFormCode().length?"custom-html":""),"api"==this.connection_type&&this.readApiElements(),this},getConnectionType:function(){return this.connection_type},setApiConnection:function(a,b){this.api_config[a]=b,this.connection_type="api"},getApiConnections:function(){return this.api_config},removeApiConnection:function(a){delete this.api_config[a],jQuery.isEmptyObject(this.api_config)&&(this.connection_type="")},setParsedResponse:function(a){this.jsonFields=a,this.customFormCode(a.stripped_code),this.persistentData()},readCustomFormCode:function(){return this.form_code=b.find(".thrv_lead_generation_code").text().replace(new RegExp(this.code_separator,"g"),""),this},writeCustomFormCode:function(){return"api"!=this.connection_type?b.find(".thrv_lead_generation_code").text(this.code_separator+this.form_code+this.code_separator):b.find(".thrv_lead_generation_code").text(""),this.config("connection",this.connection_type),this},customFormCode:function(){return arguments.length?(this.form_code=arguments[0],this):this.form_code},upgradeHtml:function(){b.attr("data-tve-version",1),b.find('input[type="text"], input[type="email"]').parent().addClass("tve_lg_input"),b.find("textarea").parent().addClass("tve_lg_textarea"),b.find("select").parent().addClass("tve_lg_dropdown"),b.find('input[type="radio"]').parents(".tve_lg_input_container ").first().addClass("tve_lg_radio"),b.find('input[type="checkbox"]').parents(".tve_lg_input_container ").first().addClass("tve_lg_checkbox"),b.find("button").parent().addClass("tve_lg_submit")},persistentData:function(){var a=this,c=!1;return"api"==this.connection_type&&jQuery("#generated_inputs_container .tve-lg-display-elem").prop("checked",!1).trigger("change"),b.find("input, select, textarea").each(function(){var b=jQuery(this),d=b.parent().find(".thrv_icon"),e=b.data("field"),f=jQuery("#txt_label_"+(e?e:""));if(c=!0,e&&(f.length||b.is("select"))){if(b.data("placeholder")&&f.val(b.data("placeholder")).trigger("change"),jQuery("#validation_"+e).val(b.data("validation")).trigger("change"),"radio"===b.attr("type")?jQuery("#required_"+b.data("parent-field")).prop("checked",b.data("required")?!0:!1).trigger("change"):jQuery("#required_"+e).prop("checked",b.data("required")?!0:!1).trigger("change"),d.length){var g=d.find(".tve_sc_icon").data("tve-icon");jQuery("#icon_"+e).prop("checked",!0).parent().append('<span data-cls="'+g+'" class="icomoon-icon"><span class="'+g+'"></span></span>'),"api"==a.connection_type&&(a.api_form_data.elements[e].icon=g,a.api_form_data.elements[e].show_icon=1)}"api"==a.connection_type&&jQuery("#elem_display_"+e).prop("checked",!0).trigger("change")}}),this},config:function(a,b){if("undefined"==typeof a|0===a.length)throw"Invalid option";return"undefined"==typeof b?this.get(a):this.set(a,b)},set:function(a,c){return b.attr("data-"+a,c),this},get:function(a){return b.attr("data-"+a)},generateContainer:function(a,c){var d=b.find('[data-field="'+a+'"]').parents(".tve_lg_input_container").first(),e=jQuery('<div class="tve_lg_input_container '+c+'"></div>');return d.length?e.attr({"class":d.attr("class"),id:d.attr("id"),style:d.attr("style")}):e},copyIconStyles:function(a,b){if(!a.length)return void b.find("span").addClass("tve_white");b.attr({style:a.attr("style"),"class":a.attr("class")});for(var c,d=a.find(".tve_sc_icon").attr("class").split(" "),e=0;c=d[e++];)-1===c.indexOf("icon-")&&b.find(".tve_sc_icon").addClass(c);return b.find(".tve_sc_icon").attr("style",a.find(".tve_sc_icon").attr("style")),a.find(".tve_sc_icon").attr("data-tve-custom-colour")&&b.find(".tve_sc_icon").attr("data-tve-custom-colour",a.find(".tve_sc_icon").attr("data-tve-custom-colour")),b},setInputPaddingForIcon:function(a,b){setTimeout(function(){if("undefined"==typeof b)return void a.css("padding-right",a.css("padding-left"));var c=b.width();c&&a.tve_css("padding-right",2*c+"px","important")},0)},_readStringProp:function(a,b){return jQuery("#"+b+"_"+a).val()},_readBoolProp:function(a,b){return jQuery("#"+b+"_"+a).is(":checked")?1:0},_copyElementStyles:function(a,b){return b.length?(a.attr("style",b.attr("style")),a.attr("class",b.attr("class")),b.attr("data-tve-custom-colour")&&a.attr("data-tve-custom-colour",b.attr("data-tve-custom-colour")),a):a},_insertIcon:function(a,b){var c=a.parent(),d=jQuery('<div class="thrv_wrapper thrv_icon tve_brdr_solid"><span></span></div>'),e=jQuery("#icon_"+a.attr("data-field")).parents("td").first().find(".icomoon-icon");e.length&&(d.find("span").attr("class","tve_sc_icon").addClass(e.attr("data-cls")).attr("data-tve-icon",e.attr("data-cls")),this.copyIconStyles(b.parent().find(".thrv_icon"),d),c.prepend(d),this.setInputPaddingForIcon(a,d))},renderTextInput:function(a,c){var d=b.find(".tve_lead_generated_inputs_container").find('input[type="text"],input[type="email"]').filter(":visible").first(),e=this._readStringProp(a,"txt_label"),f=jQuery('<input type="text" data-field="'+a+'" data-required="'+this._readBoolProp(a,"required")+'" data-validation="'+this._readStringProp(a,"validation")+'" name="'+c.name+'" placeholder="'+e+'" data-placeholder="'+e+'" />'),g=b.find('input[data-field="'+a+'"]');this._copyElementStyles(f,d);var h=this.generateContainer(a,"tve_lg_input").append(f);return this._readBoolProp(a,"icon")?(this._insertIcon(f,g),h):(this.setInputPaddingForIcon(f),h)},renderDropdown:function(a,c){var d=this._readStringProp(a,"txt_label"),e=jQuery('<select data-field="'+a+'" data-required="'+this._readBoolProp(a,"required")+'" name="'+c.name+'" data-placeholder="'+d+'"></select>'),f=b.find('select[data-field="'+a+'"]');this._copyElementStyles(e,f);var g=this.generateContainer(a,"tve_lg_dropdown tve_lg_select_container").append(e);return jQuery.each(c.options,function(a,b){""===b.value&&d&&(b.label=d),e.append(jQuery("<option></option>").val(b.value).html(b.label))}),this._readBoolProp(a,"icon")?(this._insertIcon(e,f),g):(this.setInputPaddingForIcon(e),g)},renderRadioInput:function(a,c){var d=this.generateContainer(a,"tve_lg_radio tve_clearfix"),f=this._readBoolProp(a,"required"),g=this;return jQuery.each(this.jsonFields.elements[a].options,function(h,i){var j=a+"_"+h,k=j+"_"+e++,l=g._readStringProp(j,"txt_label"),m=jQuery('<div class="tve_lg_radio_wrapper"></div>'),n=jQuery('<input data-parent-field="'+a+'" data-required="'+f+'" data-field="'+j+'" data-placeholder="'+l+'" id="'+k+'" type="radio" name="'+c.name+'" value="'+i+'" />'),o=jQuery('<label for="'+k+'">'+l+"</label>"),p=jQuery(b.find('label[for="'+j+'"]')).attr("data-tve-custom-colour");p&&o.attr("data-tve-custom-colour",p),m.append(n).append(o),d.append(m)}),d},renderTextarea:function(a,c){var d=this._readStringProp(a,"txt_label"),e=jQuery('<textarea data-field="'+a+'" data-required="'+this._readBoolProp(a,"required")+'" data-validation="'+this._readStringProp(a,"validation")+'" name="'+c.name+'" placeholder="'+d+'" data-placeholder="'+d+'"></textarea>'),f=b.find('textarea[data-field="'+a+'"]');this._copyElementStyles(e,f);var g=this.generateContainer(a,"tve_lg_textarea tve_clearfix").append(e);return this._readBoolProp(a,"icon")?(this._insertIcon(e,f),g):(this.setInputPaddingForIcon(e),g)},renderCheckboxInput:function(a,c){var d=this.generateContainer(a,"tve_lg_checkbox tve_clearfix"),f=this._readStringProp(a,"txt_label"),g=a+"_"+e++,h=jQuery('<div class="tve_lg_checkbox_wrapper"></div>'),i=jQuery('<input data-required="'+this._readBoolProp(a,"required")+'" data-field="'+a+'" data-placeholder="'+f+'" id="'+g+'" type="checkbox" name="'+c.name+'" value="'+c.value+'" />'),j=jQuery('<label for="'+g+'">'+f+"</label>"),k=jQuery(b.find('label[for="'+a+'"]')).attr("data-tve-custom-colour");return k&&j.attr("data-tve-custom-colour",k),h.append(i).append(j),d.append(h)},renderTextNode:function(a){return"<span>"+a.value+"</span>"},renderHiddenInput:function(a){return'<input id="'+a.name+'" type="hidden" name="'+a.name+'"'+(a.className?' class="'+a.className+'"':"")+' value="'+a.value+'">'},generateForm:function(){function a(a){var b=d.elements[a];if(b.processed=1,b.display||"hidden"==b.type){var c;switch(b.type){case"shortcode":c=h.renderTextNode(b);break;case"text":c=h.renderTextInput(a,b);break;case"radio":c=h.renderRadioInput(a,b);break;case"checkbox":c=h.renderCheckboxInput(a,b);break;case"select":c=h.renderDropdown(a,b);break;case"textarea":c=h.renderTextarea(a,b);break;case"hidden":c=h.renderHiddenInput(b)}c&&(g.append(c),"shortcode"!=b.type&&e++)}}for(var c,d="api"==this.connection_type?this.api_form_data:this.jsonFields,e=1,f=jQuery('<form method="'+d.form_method+'" action="'+d.form_action+'"></form>'),g=jQuery('<div class="tve_lead_generated_inputs_container tve_clearfix"><div class="tve_lead_fields_overlay"></div></div>'),h=this,i=0;c=d.element_order[i++];)d.elements[c]&&a(c);return jQuery.each(d.elements,function(b,c){return c.processed?!0:void a(b)}),f.append(d.hidden_inputs),f.append(d.not_visible_inputs),g.append('<div style="display: none">'+d.additional_fields+"</div>"),g.append(b.find(".tve_submit_container")),f.append(g),this.$formContainer.find(".tve_submit_container .thrv_icon").length&&g.find(".tve_submit_container").prepend(this.$formContainer.find(".thrv_icon")),this.$formContainer.html("").append(f),b.removeClass(function(a,b){return(b.match(/\btve_\d+/g)||[]).join(" ")}),b.attr("data-inputs-count",e),b.addClass("tve_"+e),this.writeCustomFormCode(),this},convertButtonToImage:function(){var a=b.find(".tve_submit_container");a.length&&(a.removeClass("tve_lg_submit").addClass("tve_lg_image_submit"),a.html('<div class="image_placeholder"><a id="tve_lead_pick_img" class="tve_click tve_green_button clearfix" href="#" target="_self"><i class="tve_icm tve-ic-upload"></i><span>Add Media</span></a></div>'),hide_control_panel_menu())},convertImageToButton:function(){var a=b.find(".tve_submit_container");a.length&&(a.removeClass("tve_lg_image_submit").addClass("tve_lg_submit"),a.html('<button type="submit">Submit</button>'),hide_control_panel_menu())},applyStyle:function(a){a||(a=b.is(".thrv_lead_generation_vertical")?"thrv_lead_generation_vertical":"thrv_lead_generation_horizontal"),b.removeClass("thrv_lead_generation_vertical thrv_lead_generation_horizontal").addClass(a).find(".tve_lg_input_container").removeClass("tve_lg_2 tve_lg_3");var c=b.find(".tve_lg_input,.tve_lg_radio,.tve_lg_checkbox,.tve_lg_textarea").length;1===c||3===c?b.find(".tve_lg_input_container").addClass("tve_lg_2"):c>=2&&b.find(".tve_lg_input_container").addClass("tve_lg_3")},readApiElements:function(){this.api_form_data.thank_you_url=b.find("input#_back_url").val()||"",this.api_form_data.submit_option=b.find("input#_submit_option").val()||"reload",this.api_config_str=b.find("#__tcb_lg_fc").val(),this.api_form_data.element_order=[];var a=this;b.find("input,select,textarea").each(function(){var b=jQuery(this).attr("data-field");b&&a.api_form_data.element_order.push(jQuery(this).attr("data-field"))}),this.api_form_data.extra=TVE_Content_Builder.auto_responder.api.readExtraSettings(b)},setApiData:function(b){var c=this;jQuery.each(b,function(a,b){"lb_html"!=a&&"elements"!=a&&(c.api_form_data[a]=b)}),this.api_config=b.connections,jQuery("#generated_inputs_container").on("change","input,select",function(){var a=jQuery(this),b=this.id.replace(/txt_label_|validation_|required_|icon_|elem_display_/,"");c.api_form_data.elements[b][a.attr("data-elem-field")]=a.is("input[type=checkbox]")?a.is(":checked")?1:0:a.val()}),this.api_form_data.elements?(jQuery.each(b.elements,function(a,b){return c.api_form_data.elements[a]?void(c.api_form_data.elements[a].value=b.value):(c.api_form_data.elements[a]=b,!0)}),jQuery.each(this.api_form_data.elements,function(a,b){b.label&&jQuery("#txt_label_"+a).val(b.label),b.validation&&jQuery("#validation_"+a).val(b.validation),jQuery("#required_"+a).prop("checked",b.required?!0:!1),jQuery("#elem_display_"+a).prop("checked",b.display?!0:!1);var c=jQuery("#icon_"+a).prop("checked",b.show_icon?!0:!1);b.icon&&c.parent().append('<span data-cls="'+b.icon+'" class="icomoon-icon"><span class="'+b.icon+'"></span></span>')})):(this.api_form_data.elements=b.elements,this.api_form_data.element_order=b.element_order,this.persistentData());var d=jQuery("#generated_inputs_container table tbody").sortable({handle:".tve-drag-handle",axis:"y",helper:function(b,c){var d=c.clone().empty();return c.find("td").each(function(){var b=a(this);d.append(b.clone().css("width",b.width()+"px").css("height",b.height()+"px"))}),d},update:function(){c.api_form_data.element_order=[],d.find(".lg_elem_field").each(function(){c.api_form_data.element_order.push(this.value)})}})}};return c.init()}})}(jQuery);