/*! Thrive Content Builder - 2015-12-02
* http://www.thrivethemes.com/
* Copyright (c) 2015 Thrive Themes */
var TVE_Content_Builder=TVE_Content_Builder||{};!function(a){var b=".thrv_wrapper, p:not(.thrv_custom_html_shortcode p, .wp-caption p), ul:not(ul.tve_clearfix), ol, h1, h2, h3, h4, h5, h6, address, pre, blockquote",c=".tve_no_drag, .thrive_leads_shortcode *, .tve_faqB *, .tve_wp_shortcode *, .thrv_bullets_shortcode ul, .thrv_tw_qs *, .thrv_post_grid *, .thrv_custom_html_shortcode *, .thrv_widget *, .thrv_widget_menu *, .tve_w_menu, .tve_w_menu *, .tve_lg_input_container *",d=".tve_colm, .tve_colm .tve_grt, .tve_cb div:not(.thrive-shortcode-config,.tve_dropzone), .tve_faqC, td, th, .fwi, .tve_content_inner, .thrv_content_reveal, .tve_scTC, .cck, .tve_empty_dropzone",e='<div class="tve_dropzone"></div>',f=null,g=null,h=-1!=navigator.userAgent.toLowerCase().indexOf("msie")?parseInt(navigator.userAgent.toLowerCase().split("msie")[1]):!1,i=null,j="tve_grabbed",k=null,l=!1,m=function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,function(b){return b||(b=window.event),c.call(a,b)})},n={init:function(){b=TVE_Content_Builder.apply_filters("sortable_elements",b),i=this.page_scroll("tcb_lightbox"===tve_path_params.post_type?"#tve-p-scroller":"body"),a("#tve_cpanel").on("click",".cp_draggable",function(){TVE_Editor_Page.enable(),n.fetch(a(this),n.get_dropzone())}),a(".cp_draggable").attr("draggable","true").each(function(){n.make_draggable(this)}),this.drop_forbid=a(".tve_drop_constraint"),this.bind_editor_actions()},editorActions:function(){TVE_Editor_Page.editor.find(b).not(c).addClass("tve_draggable").attr("draggable","true").each(function(){n.make_draggable(this)}),this.refresh()},get_dropzone:function(){var b=a(".edit_mode"),c=a("#tve_editor");if(0!==b.length)return b.nextAll(".tve_dropzone").first();var d=c.find(".tve_editor_main_content");0===d.length&&(d=c);var e=d.first().children(".tve_dropzone");return e.length?e.last():(d.first().append('<div class="tve_dropzone" style="height:0px"></div>'),d.children(".tve_dropzone").last())},dragstart:function(b){var c=a(this),d=c.attr("data-elem");return TVE_Content_Builder.edit_element&&!c.hasClass(j)?(b.preventDefault(),!1):(TVE_Content_Builder.loaded_menu&&n.hide_control_panel(),b.stopPropagation&&b.stopPropagation(),f=(c.hasClass(j)?TVE_Editor_Page.editor.find("."+j):c).addClass("tve-dragged"),g=f.next(".tve_dropzone"),setTimeout(function(){a("body").addClass("tve-dragging")},20),n.drop_forbid.removeClass("tve_drop_forbidden").each(function(){var b=a(this);f.is(b.attr("data-forbid"))&&b.addClass("tve_drop_forbidden")}),b.dataTransfer.effectAllowed="copy",void b.dataTransfer.setData("Text",d?d:"some_unique_id"+Math.random().toString()))},dragend:function(){a("body").removeClass("tve-dragging"),a(".tve-dragged").removeClass("tve-dragged"),f=null,i.hide(),n.show_control_panel()},dragenter:function(){a(this).addClass("tve_dragged_over")},dragover:function(a){return a.preventDefault&&a.preventDefault(),a.dataTransfer.dropEffect="copy",!1},dragleave:function(){a(this).removeClass("tve_dragged_over")},drop:function(b){var c=a(this);if(b.stopPropagation&&b.stopPropagation(),b.preventDefault&&b.preventDefault(),a("body").removeClass("tve-dragging"),f.removeClass("tve-dragged tve-draggable"),i.hide(),f.is("#tve_cpanel .cp_draggable"))n.fetch(f,c);else{if(c.is(a(".tve_dropzone",f)))return c.removeClass("tve_dragged_over"),!1;c.removeClass("tve_dragged_over"),tve_set_window_content_before_action(),g&&!g.is(c)&&g.remove(),c.replaceWith(f),n.ensure_dropzones(f),f.hasClass("thrv_social_default")&&TVE_Content_Builder.social.onDefaultDrop(f),tve_set_window_content_after_action(),f.length>1&&(n.refresh(!1),TVE_Content_Builder.loaded_menu&&(clearFocus({forceExit:1,keep_selection:!0}),setTimeout(function(){n.get_selected().first().click()})))}return f=null,!1},bind_draggable:function(a){a.filter(b).not(c).addClass("tve_draggable").attr("draggable","true").each(function(){n.make_draggable(this)}),a.find(b).not(c).addClass("tve_draggable").attr("draggable","true").each(function(){n.make_draggable(this)})},make_draggable:function(b){function c(a){a.toggleClass(j),a.data("tve-el-type")||a.data("tve-el-type",get_shortcode_type_from_edit_mode(a)),d(a)}function d(a){var b=a.find("."+j).removeClass(j+" edit_mode");TVE_Content_Builder.edit_element&&TVE_Content_Builder.edit_element.length&&(TVE_Content_Builder.edit_element=TVE_Content_Builder.edit_element.not(b),TVE_Content_Builder.edit_element.length||delete TVE_Content_Builder.edit_element)}var e=a(b);m(b,"dragstart",n.dragstart),m(b,"dragend",n.dragend),h&&m(b,"selectstart",function(b){return a(".edit_mode").length?!0:(b.preventDefault&&b.preventDefault(),b.stopPropagation&&b.stopPropagation(),this.dragDrop&&this.dragDrop(),!1)}),e.off("mousedown.tveselection").on("mousedown.tveselection",function(a){if("disabled"!==TVE_Editor_Page.STATE&&l){if(e.parents("."+j).length)return;if(k=null,c(e),!e.hasClass(j))return TVE_Content_Builder.edit_element&&TVE_Content_Builder.edit_element.length>1&&(e.removeClass("edit_mode"),TVE_Content_Builder.edit_element=TVE_Content_Builder.edit_element.not(e)),!1;TVE_Content_Builder.edit_element&&!TVE_Content_Builder.edit_element.parents("."+j).length&&c(TVE_Content_Builder.edit_element.removeClass(j));var b=n.selection();return b.has_items&&(TVE_Editor_Page.STATE="multi-selection",b.type&&TVE_Content_Builder.loaded_menu&&setTimeout(function(){b.items.first().click(),b.items.attr("draggable","true")},10),clearFocus({forceExit:1,keep_selection:!0})),!1}})},refresh:function(d){"undefined"==typeof d&&(d=!1),d&&a("#tve_editor").find(b).not(c).addClass("tve_draggable").attr("draggable","true").each(function(){n.make_draggable(this)}),this.dropzones(),a(".tve_dropzone").each(function(){n.dropzone_events(this)})},dropzone_events:function(a){a.jquery&&(a=a[0]),m(a,"dragenter",this.dragenter),m(a,"dragover",this.dragover),m(a,"dragleave",this.dragleave),m(a,"drop",this.drop)},dropzones:function(){var f=TVE_Editor_Page.editor.css("min-height",TVE_Editor_Page.editor.height()+"px");a(".tve_dropzone").remove(),f.find(b).not(c).each(function(){var a=jQuery(this).after(e);(a.is(":first-child")||!a.prev().is(":visible"))&&a.before(e)}),f.find(d).each(function(){var b=a(this);a.trim(b.text())||0!==b.children(":visible").length||b.append(e)}),0===f.find("*:visible").length&&f.append(e),f.css("min-height",""),f=null},ensure_dropzones:function(f){return f.length>1?void f.each(function(){n.ensure_dropzones(a(this))}):(f.is(b)&&!f.next().is(".tve_dropzone")&&(f.after(e),n.dropzone_events(f.next())),f.is(b)&&!f.prev().is(".tve_dropzone")&&(f.before(e),n.dropzone_events(f.prev())),f.find(b).not(c).each(function(){var b=a(this);b.prev().is(".tve_dropzone")||(b.before(e),n.dropzone_events(b.prev())),b.next().is(".tve_dropzone")||(b.after(e),n.dropzone_events(b.next()))}),void(f.is(d)&&!a.trim(f.text())&&0===f.children(":visible").length&&(f.prepend(e),n.dropzone_events(f.children().first()))))},fetch:function(b,c){var d=b.find("input").serializeArray(),e=b.attr("data-elem"),f=b.attr("data-wpapi")?tve_path_params.ajax_url:tve_path_params.shortcodes_dir+e+".php";return this.before_fetch(e,b,c)===!1?!1:this.check_for_static_elements(e,c)?!0:-1===a.inArray(e+".php",tve_path_params.shortcodes_array)?!1:(b.attr("data-overlay")&&TVE_Editor_Page.overlay(),d.push({name:"colour",value:window.last_colour_used}),d.push({name:"cssdir",value:tve_path_params.editor_dir}),b.attr("data-wpapi")&&(d.push({name:"action",value:"tve_ajax_load"}),d.push({name:"ajax_load",value:e})),a.post(f,a.param(d),function(a){n.insert(a,c),TVE_Editor_Page.overlay("close")}),!1)},check_for_static_elements:function(a,b){var c=jQuery("#tve_static_elements").find("[data-elem='"+a+"']");if(c.length<=0)return!1;var d=c.first().clone();return d.find(".tve_red").removeClass("tve_red").addClass(window.last_colour_used),n.insert(d.html(),b),!0},before_fetch:function(a,b,c){return b.hasClass("user_template_item")?(this.load_template(jQuery.trim(b.find(".tpl_key").val()),c),!1):!0},after_fetch:function(a){a.hasClass("thrv_content_container_shortcode")?a.parent().addClass("tve_clearfix"):a.hasClass("thrv_countdown_timer")?a.hasClass("tve_countdown_timer_evergreen")?a.tve_countdown_timer_evergreen().update():a.tve_countdown_timer().update():a.find(".tve_vtabs").length?a.tve_tabs().resize():a.is(".thrv_lead_generation")?a.tve_lead_generation().applyStyle("thrv_lead_generation_vertical"):a.hasClass("thrv_social_default")&&TVE_Content_Builder.social.onDefaultInsert(a)},insert:function(b,c,d){"undefined"==typeof d&&(d=!1),a(".tve_dropzone").removeClass("tve_dragged_over"),tve_set_window_content_before_action();var e=a(b);return d?(c.html(e),e.hasClass("tve_table")&&(e=e.parent())):(c.replaceWith(e),e.find(".tve_dropzone").each(function(){n.dropzone_events(this)}),e.filter(".tve_dropzone").each(function(){n.dropzone_events(this)})),this.ensure_dropzones(e),this.bind_draggable(e),n.after_fetch(e),tve_set_window_content_after_action(),e},before_remove:function(a){a.next().is(".tve_dropzone")&&a.next().remove()},after_clone:function(a,b){b.find(".tve_dropzone").each(function(){n.dropzone_events(this)}),this.bind_draggable(b),this.ensure_dropzones(a),this.ensure_dropzones(b),b.hasClass("thrv_social_default")&&TVE_Content_Builder.social.onDefaultDrop(b)},load_template:function(b,c){var d={action:"tve_load_user_template",template_key:b,security:tve_path_params.tve_ajax_nonce,dataType:"json"};TVE_Editor_Page.overlay(),jQuery.post(tve_path_params.ajax_url,d,function(b){b=JSON.parse(b),a(".tve_dropzone").removeClass("tve_dragged_over"),tve_set_window_content_before_action();var d=a(b.html_code);d=tve_process_saved_template(b.css_code,d),TVE_Editor_Page.overlay("close"),c.replaceWith(d),n.bind_draggable(d),tve_set_window_content_after_action(),n.refresh()}).fail(function(a){tve_add_notification("Something went wrong. Response was: "+a.responseText,!0,7e3),TVE_Editor_Page.overlay("close")})},page_scroll:function(b){"undefined"==typeof b&&(b="body");var c=a('<div id="tve_page_scroller_top" class="tve_window_drag_scroll"><span class="tve_arrow tve_icm tve-ic-caret-up"></span><div class="tve_drag_events"></div></div>').appendTo(b),d=a('<div id="tve_page_scroller_bottom" class="tve_window_drag_scroll"><span class="tve_arrow tve_icm tve-ic-caret-down"></span><div class="tve_drag_events"></div></div>').appendTo(b),e=c.add(d),f=null,g=null,h=function(b,e){"undefined"==typeof e&&(e=!1);var f=c.parent();if(f.is("body")&&(f=a("body,html")),f.is(":animated"))return!0;var g=f.is("body")?a(window).scrollTop():f.scrollTop();return-1==b?(d.removeClass("tve_scroll_hide"),0===g?c.addClass("tve_scroll_hide").removeClass("tve_drag_hover"):c.removeClass("tve_scroll_hide")):(c.removeClass("tve_scroll_hide"),g+a(window).height()>=a("body").height()-45?d.addClass("tve_scroll_hide").removeClass("tve_drag_hover"):d.removeClass("tve_scroll_hide")),e||f.animate({scrollTop:g+120*b},80,"linear"),!0};return e.each(function(){var b=a(this),d=b.children(".tve_drag_events").get(0);m(d,"dragenter",function(){var b=a(this).parent(),d=b.is(c)?-1:1;clearInterval(g),f=d,g=setInterval(function(){h(d)},20),b.addClass("tve_drag_hover")}),m(d,"dragleave",function(b){clearInterval(g),a(this).parent().removeClass("tve_drag_hover")})}),h(-1,!0),{show:function(){e.show()},hide:function(){clearInterval(g),e.removeClass("tve_drag_hover tve_scroll_hide")}}},get_selection_type:function(b){var c=!1;return b.length?(b.each(function(){return c===!1?(c=a(this).data("tve-el-type"),!0):c!=a(this).data("tve-el-type")?(c=!1,!1):void 0}),c):!1},hide_control_panel:function(){a("#tve_cpanel_onpage").addClass("tve_menu_force_hide")},show_control_panel:function(){a("#tve_cpanel_onpage").removeClass("tve_menu_force_hide")},bind_editor_actions:function(){var b=a("body");b.on("mousemove",function(a){1!==a.which&&b.hasClass("tve-dragging")&&b.removeClass("tve-dragging")}).on("keyup",function(a){27==a.which&&n.clear_selection()}).on("mouseup.tveselection",function(b){var c=a(b.target);l||a(".edit_mode").length||c.closest("."+j).length||n.clear_selection()}).on("keydown",function(b){if(17==b.which||b.metaKey){if(a(b.target).parents("#tve_cpanel_onpage").length)return;l=!0,n.hide_control_panel()}}).on("keyup",function(a){(17==a.which||91==a.which||93==a.which||224==a.which)&&(l=!1,n.show_control_panel())})},get_selected:function(){return TVE_Editor_Page.editor.find("."+j)},clear_selection:function(){this.get_selected().removeClass(j),k=null,TVE_Editor_Page.STATE="enabled"},selection:function(){var a=this.get_selected();return null===k&&(k=this.get_selection_type(a)),{items:a,type:k||!1,has_items:a.length}}};TVE_Content_Builder.drag=n}(jQuery);